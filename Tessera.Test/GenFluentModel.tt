<#@ template debug="false" language="C#" #>
<#@ output extension="cs" #>
<#@ assembly name="System.Core.dll" #>
<#@ assembly name="System.Data.dll" #>
<#@ assembly name="System.Data.Linq.dll" #>
<#@ assembly name="System.Configuration.dll" #>
<#@ assembly name="$(ProjectDir)$(OutDir)Nephrite.Meta.Database.DB2.dll" #>
<#@ assembly name="$(ProjectDir)$(OutDir)Nephrite.Web.dll" #>
<#@ assembly name="$(ProjectDir)$(OutDir)NHibernate.dll" #>
<#@ import namespace="System" #>
<#@ import namespace="System.Collections.Generic" #>
<#@ import namespace="System.Text.RegularExpressions" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Text" #>
<#@ import namespace="Nephrite.Meta" #>
<#@ import namespace="Nephrite.Meta.Database" #>
<#@ import namespace="Nephrite.Web" #>
<#@ import namespace="Nephrite.Web.Hibernate" #>
<#@ import namespace="Nephrite.Web.CoreDataContext" #>
<#@ import namespace="NHibernate.Cfg.Loquacious" #>
<# 
	A.DBScript = new DBScriptMSSQL("DBO");
	ConnectionManager.SetConnectionString("Integrated Security=SSPI;Persist Security Info=False;Initial Catalog=Servants;Data Source=(local)");
	HDataContext.DBType = DBType.MSSQL;
	//A.DBScript = new DBScriptDB2("DBO");
	//ConnectionManager.SetConnectionString("Database=SRVNTS;UserID=dbo;Password=123*(iop;Server=176.227.213.5:50000");
	//HDataContext.DBType = DBType.DB2;

	A.Model = new HCoreDataContext(HCoreDataContext.DefaultDBConfig(ConnectionManager.ConnectionString), null);
	var model = MetaSolution.Load();

#>
using System;
using System.Linq;
using Nephrite.Meta;
using Nephrite.Meta.Fluent;

namespace Solution.Model
{
<# foreach (var pck in model.Packages) { #>
<# foreach (var cls in pck.Classes) { #>
	public partial class <#=cls.Name#> { }
<# } #>

	public class <#=pck.Name#>Package
	{
		public static MetaPackage Create()
		{
			var p = new MetaPackage("<#=pck.Name#>");
<# foreach (var cdf in pck.Enums) { #>
			p.AddEnum("<#=cdf.Name#>", "<#=cdf.Caption#>")
<#	var lastcdf = cdf.Values.Last();
	foreach (var val in cdf.Values) { #>
				.Value("<#=val.ID#>", "<#=val.Name#>", "<#=val.Caption#>")<# if (val == lastcdf) { #>;<# } #>

<#	} #>

<# } #>
<# foreach (var cls in pck.Classes) { #>
			p.AddClass<<#=cls.Name#>>()
<#		if (cls.CompositeKey.Count == 1 && cls.Key is MetaAttribute) {
			int i = cls.Name.IndexOf('_'); if (i == -1) i = 0; else i++;
			string keyName = cls.Name.Substring(i) + (cls.Key.Type as IMetaIdentifierType).ColumnSuffix;
			if (cls.Key.Type is MetaIntType) { #>
				.IntKey(<#=keyName == cls.Key.Name ? "" : ("\"" + cls.Key.Name + "\"")#>)
<#			} #>
<#			if (cls.Key.Type is MetaGuidType) { #>
				.GuidKey(<#=keyName == cls.Key.Name ? "" : ("\"" + cls.Key.Name + "\"")#>)
<#			} 
		} #>
<#		if (!cls.IsPersistent) { #>
				.NonPersistent()
<#		} #>
<#		if (cls.Properties.Any(o => o.Name == "LastModifiedDate") && cls.Properties.Any(o => o.Name == "LastModifiedUser")) { #>
				.TimeStamp<SPM_Subject>()
<#		} #>
<#		foreach (var prop in cls.Properties.Where(o => !o.Name.In("LastModifiedDate", "LastModifiedUser"))) {
			if (prop is MetaAttribute && !cls.CompositeKey.Contains(prop)) { #>
<#				string typeparm = prop.Type is MetaEnumType ? "\"" + prop.Type.Name + "\"" : ""; #>
				.Attribute("<#=prop.Name#>", "<#=prop.Caption#>", <#=prop.Type.GetType().Name#>.<#=(prop.Type as MetaPrimitiveType).NotNullable ? "NotNull(" + typeparm + ")" : "Null(" + typeparm + ")"#><# if ((prop as MetaAttribute).IsMultilingual) {#>, true<#}#>)
<#			}
			if (prop is MetaComputedAttribute) { #>
				.ComputedAttribute("<#=prop.Name#>", "<#=prop.Caption#>", <#=prop.Type.GetType().Name#>.<#=(prop.Type as MetaPrimitiveType).NotNullable ? "NotNull()" : "Null()"#>)
<#			}
			if (prop is MetaPersistentComputedAttribute) { #>
				.PersistentComputedAttribute("<#=prop.Name#>", "<#=prop.Caption#>", <#=prop.Type.GetType().Name#>.<#=(prop.Type as MetaPrimitiveType).NotNullable ? "NotNull()" : "Null()"#><# if ((prop as MetaPersistentComputedAttribute).IsMultilingual) {#>, true<#}#>)
<#			}

			if (prop is MetaReference) { 
				var r = prop as MetaReference;
				string add = "";
				if (r.UpperBound == -1) add += ".Multiple()";
				if (r.AssociationType == AssociationType.Aggregation) add += ".Aggregation()";
				if (r.InverseProperty != null) add += @".InverseProperty(""" + r.InverseProperty.Name + @""")";
			#>
<#				if (cls.CompositeKey.Contains(prop)) { #>
				.ReferenceKey<<#=r.RefClass.Name#>>("<#=prop.Name#>", "<#=prop.Caption#>"<#=!add.IsEmpty() ? ", x => x" + add : "" #>)
<#				} else { #>
				.Reference<<#=r.RefClass.Name#>>("<#=prop.Name#>", "<#=prop.Caption#>"<#=!add.IsEmpty() ? ", x => x" + add : "" #>)
<#				} #>
<#			} 
		} #>
<#		foreach (var op in cls.Operations) { #>
<#			if (op.Name == "CreateNew" && op.Caption == "Создать") {  #>
				.OperationCreateNew(<# GenStdOperation(op, "edit", new int[] { 0, 1 }); #>
<#			} else if (op.Name == "ViewList" && op.Caption == "Список") {  #>
				.OperationList(<# GenStdOperation(op, "list", new int[] { 0 }); #>
<#			} else if (op.Name == "Edit" && op.Caption.In("Редактировать", "Редактирование")) { #>
				.OperationEdit(<# GenStdOperation(op, "edit", new int[] { 0, 2 }); #>
<#			} else if (op.Name == "View" && op.Caption == "Просмотр") { #>
				.OperationView(<# GenStdOperation(op, "view", new int[] { 0, 2 }); #>
<#			} else if (op.Name == "Delete" && op.Caption == "Удалить") { #>
				.OperationDelete(<# GenStdOperation(op, "delete", new int[] { 0, 2 }); #>
<#			} else if (op.Name == "UnDelete" && op.Caption.In("Восстановить", "Отмена удаления", "Отменить удаление")) { #>
				.OperationUnDelete(<# GenStdOperation(op, "undelete", new int[] { 0, 2 }); #>
<#			} else { #>
				.Operation("<#=op.Name#>", "<#=op.Caption#>"<# if (op.Parameters.Count > 0 || !op.ViewName.IsEmpty()) { #>, x => x<# } else {#>)<# } #> 
<#				GenParms(op.Parameters); #>
<#				if (!op.ViewName.IsEmpty()) GenInvokes(op, op.ViewName); #>
<#				if (op.Parameters.Count > 0 || !op.ViewName.IsEmpty()) { #>
				)
<#				} #>
<#			} #>
<# } #>
			;	
<# } #>
			return p;
		}
	}
<# } #>
}

<#+
void GenParms(List<MetaOperationParameter> parms)
{
	foreach (var p in parms) {
		if (p.Type is MetaIntType) { #>
					.ParmInt("<#=p.Name#>")
<#+		}
		if (p.Type is MetaStringType) { #>
					.ParmString("<#=p.Name#>")
<#+		}
		if (p.Type is MetaGuidType) { #>
					.ParmGuid("<#=p.Name#>")
<#+		}
	}
}

void GenStdOperation(MetaOperation op, string name, int[] propcnt)
{
	bool stname = (op.ViewName ?? "").ToLower() == name;
	bool stprop = Enumerable.Contains(propcnt, op.Parameters.Count);
	if ((stname && stprop) || (!stname && stprop && !String.IsNullOrEmpty(op.ActionString))) { #>)<#+ } else { #>x => x<#+ } #> 
<#+	if (!stprop) GenParms(op.Parameters); #>
<#+	if (!stname && String.IsNullOrEmpty(op.ActionString)) GenInvokes(op, op.ViewName ?? name); #>
<#+	if ((!stname && String.IsNullOrEmpty(op.ActionString)) || !stprop) { #>
				)
<#+	} 
}

void GenInvokes(MetaOperation op, string name)
{
	string mname = "InvokesView";
	if (op.ViewClass.In("Nephrite.Web.ViewControl<{0}>", "ViewControl<{0}>") 
	|| (op.ViewClass.IsEmpty() && name.In("edit", "view", "createnew", "delete", "undelete"))) {
#>
					.InvokesSingleObjectView("<#=name#>")
<#+ } else if (op.ViewClass.In("Nephrite.Web.ViewControl<IQueryable<{0}>>", "ViewControl<IQueryable<{0}>>")
	|| (op.ViewClass.IsEmpty() && name.In("list"))) { #>
					.InvokesObjectListView("<#=name#>")
<#+ } else { #>
					.InvokesView("<#=op.ViewClass ?? ""#>", "<#=name#>")
<#+
	}
}
#>